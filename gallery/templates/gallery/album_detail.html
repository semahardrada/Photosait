{% extends "base.html" %}
{% load static %}

{% block title %}Альбом: {{ album.title }}{% endblock %}

{% block content %}

<!-- === МОДАЛЬНОЕ ОКНО ОФЕРТЫ (HTML без изменений) === -->
<div id="oferta-backdrop" class="hidden fixed inset-0 z-40 bg-black bg-opacity-75"></div>
<div id="oferta-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
        
        <div class="p-6 md:p-8 overflow-y-auto" style="max-height: 70vh;">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Публичная оферта группы</h3>
            <p class="text-gray-700 mb-4 text-sm">
                Интернет-магазин «[ТВОЕ НАЗВАНИЕ]», расположенный в интернете по уникальным адресом [ТВОЙ АДРЕС], от имени [ТВОЕ ИП/ООО], именуемое в дальнейшем «Продавец», публикует Публичную оферту о продаже Товара дистанционным способом.
            </p>
            <h4 class="font-bold text-lg mb-2">1. Термины и определения</h4>
            <p class="text-gray-600 text-sm mb-4">
                1.1. Оферта – публичное предложение Продавца, адресованное неопределенному кругу лиц, заключить с Продавцом договор купли-продажи товара дистанционным способом (далее по тексту – Договор) на условиях, содержащихся в настоящей Оферте, включая все Приложения.
            </p>
            <p class="text-gray-600 text-sm mb-4">
                <em>[... Вставь сюда свой полный текст оферты ...]</em>
            </p>
        </div>
        
        <div class="p-6 bg-gray-50 rounded-b-lg text-center">
            <button id="oferta-accept-btn" type="button" class="bg-pink-600 text-white font-bold py-3 px-12 rounded-lg transition-colors hover:bg-pink-700">
                принимаю
            </button>
        </div>
    </div>
</div>
<!-- === КОНЕЦ МОДАЛЬНОГО ОКНА ОФЕРТЫ === -->


<!-- ВЕСЬ ОСТАЛЬНОЙ КОНТЕНТ СТРАНИЦЫ -->
<div class="max-w-7xl mx-auto">
    <div class="bg-white p-6 rounded-lg shadow-md mb-8 text-center">
        <h1 class="text-4xl font-bold text-gray-800">{{ album.title }}</h1>
        {% if album.description %}
            <p class="text-gray-600 mt-2">{{ album.description }}</p>
        {% endif %}
        {% if album.expires_at %}
        <div id="album-timer-{{ album.id }}" class="mt-4 text-xl font-semibold text-red-600">
            До конца сессии осталось:
            <div class="text-3xl tracking-widest mt-2">
                <span class="timer-days">00</span>:<span class="timer-hours">00</span>:<span class="timer-minutes">00</span>:<span class="timer-seconds">00</span>
            </div>
        </div>
        {% endif %}
    </div>

    <div id="photo-gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {% for photo in photos %}
        <div class="photo-item relative cursor-pointer border-4 border-transparent rounded-lg overflow-hidden group" data-photo-id="{{ photo.id }}">
            {% if photo.processed_image %}
                <img src="{{ photo.processed_image.url }}" alt="Фото {{ photo.id }}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
            {% else %}
                <img src="https://placehold.co/600x400/eeeeee/cccccc?text=Processing..." alt="Фото {{ photo.id }} в обработке" class="w-full h-full object-cover">
            {% endif %}
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 flex items-center justify-center">
                <div class="check-icon hidden w-12 h-12 bg-green-500 rounded-full items-center justify-center">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Нижняя панель -->
<div class="sticky bottom-0 left-0 right-0 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 mt-8 z-10">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
        <div>
            <h3 class="font-bold text-lg text-gray-800">Ваш заказ:</h3>
            <p class="text-gray-600"><span id="selected-count">0</span> фото выбрано</p>
        </div>
        
        <form id="go-to-cart-form" 
              action="{% url 'orders:cart' %}" 
              method="POST" 
              class="w-full md:w-auto"
              data-album-id="{{ album.id }}">
            {% csrf_token %}
            <input type="hidden" name="cart_data" id="cart-data-input">
            <button id="go-to-cart-btn" type="submit" disabled class="w-full bg-gray-400 text-white font-bold py-3 px-6 rounded-lg transition-colors md:w-auto">
                Перейти в корзину
            </button>
        </form>
    </div>
</div>
{% endblock %}


<!-- ===  JAVASCRIPT === -->
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- ОБЩИЕ ЭЛЕМЕНТЫ (для Оферты и Выбора) ---
    const goToCartForm = document.getElementById('go-to-cart-form');
    // Если этой формы нет, мы не на странице альбома.
    if (!goToCartForm) return;

    // === Получаем ID альбома из формы ===
    const albumId = goToCartForm.dataset.albumId; 


    // --- (A) ЛОГИКА МОДАЛЬНОГО ОКНА ОФЕРТЫ ---
    const modal = document.getElementById('oferta-modal');
    const backdrop = document.getElementById('oferta-backdrop');
    const acceptBtn = document.getElementById('oferta-accept-btn');

    // 1. === Создаем УНИКАЛЬНЫЙ ключ для этого альбома ===
    const storageKey = `ofertaAccepted_${albumId}`; // e.g., 'ofertaAccepted_UUID...'

    // 2. === Проверяем, принял ли пользователь оферту для ЭТОГО АЛЬБОМА ===
    if (sessionStorage.getItem(storageKey) !== 'true') {
        // Если нет, показываем окно
        modal.classList.remove('hidden');
        backdrop.classList.remove('hidden');
    }

    // 3. Обработчик нажатия кнопки "принимаю"
    acceptBtn.addEventListener('click', () => {
        // Прячем окно
        modal.classList.add('hidden');
        backdrop.classList.add('hidden');
        // 4. === Запоминаем в сессии, что пользователь согласился ДЛЯ ЭТОГО АЛЬБОМА ===
        sessionStorage.setItem(storageKey, 'true');
    });
    // --- (A) КОНЕЦ ЛОГИКИ ОФЕРТЫ ---


    // --- (B) ЛОГИКА ВЫБОРА ФОТО (старый код, без изменений) ---
    const photoItems = document.querySelectorAll('.photo-item');
    const selectedCountEl = document.getElementById('selected-count');
    const cartDataInput = document.getElementById('cart-data-input');
    const goToCartBtn = document.getElementById('go-to-cart-btn');

    let selectedPhotos = new Set();

    const updateUI = () => {
        selectedCountEl.textContent = selectedPhotos.size;
        
        if (selectedPhotos.size > 0) {
            goToCartBtn.disabled = false;
            goToCartBtn.classList.remove('bg-gray-400');
            goToCartBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        } else {
            goToCartBtn.disabled = true;
            goToCartBtn.classList.add('bg-gray-400');
            goToCartBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        }
    };

    const togglePhotoSelection = (photoEl) => {
        const photoId = photoEl.dataset.photoId;
        const checkIcon = photoEl.querySelector('.check-icon');
        
        if (selectedPhotos.has(photoId)) {
            selectedPhotos.delete(photoId);
            photoEl.classList.remove('border-green-500');
            checkIcon.classList.add('hidden');
        } else {
            selectedPhotos.add(photoId);
            photoEl.classList.add('border-green-500');
            checkIcon.classList.remove('hidden');
            checkIcon.classList.add('flex');
        }
        updateUI();
    };

    photoItems.forEach(item => item.addEventListener('click', () => togglePhotoSelection(item)));

    goToCartForm.addEventListener('submit', (e) => {
        if (selectedPhotos.size === 0) {
            e.preventDefault();
            console.error('Пожалуйста, выберите хотя бы одну фотографию.');
            return;
        }
        
        // ID альбома уже получен в самом начале (const albumId)
        const cartData = {
            photo_ids: Array.from(selectedPhotos),
            album_id: albumId
        };
        cartDataInput.value = JSON.stringify(cartData);
    });

    updateUI(); // Первоначальная настройка кнопки
    // --- (B) КОНЕЦ ЛОГИКИ ВЫБОРА ФОТО ---
});
</script>
{% endblock %}