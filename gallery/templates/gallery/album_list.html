{% extends "base.html" %}

{% block title %}{{ page_title|default:"Галерея" }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8">
    
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">{{ album.title }}</h1>
        {% if album.parent %}
            <a href="{% url 'gallery:album_detail' album.parent.access_token %}" class="text-blue-600 hover:underline">&larr; Назад к {{ album.parent.title }}</a>
        {% else %}
            <a href="{% url 'gallery:landing' %}" class="text-blue-600 hover:underline">&larr; На главную</a>
        {% endif %}
    </div>

    <!-- ТАЙМЕР -->
    {% if not is_expired and album.expires_at %}
    <div class="mb-8 p-6 bg-white rounded-xl shadow-lg border border-blue-100 text-center max-w-2xl mx-auto">
        <h3 class="text-xl font-bold text-gray-800 mb-2">Уважаемые родители!</h3>
        <p class="text-gray-600 mb-4">
            Оформить заказ можно не позднее: <span class="font-bold">{{ album.expires_at|date:"d.m.Y H:i" }}</span>.
        </p>
        
        <div class="text-sm text-gray-500 mb-1">до конца сессии осталось:</div>
        
        <!-- ВАЖНО: Передаем дату в ISO формате (c) для JS -->
        <div id="countdown-timer" 
             data-expires="{{ album.expires_at|date:'c' }}" 
             class="text-4xl md:text-5xl font-mono font-bold text-red-600 tracking-wider">
             --:--:--:--
        </div>
        <div class="text-xs text-gray-400 mt-2 flex justify-center gap-4 md:gap-8">
            <span>ДНЕЙ</span><span>ЧАСОВ</span><span>МИНУТ</span><span>СЕКУНД</span>
        </div>

        <p class="text-xs text-red-500 mt-4">Пожалуйста, не откладывайте выбор фотографий на последний момент!</p>
    </div>
    {% elif is_expired %}
    <div class="mb-8 p-6 bg-red-50 rounded-xl border border-red-200 text-center text-red-700">
        {{ expired_message|safe }}
    </div>
    {% endif %}

    <!-- Сетка альбомов -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for item in albums %}
        <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300 group">
            <a href="{% url 'gallery:album_detail' item.access_token %}" class="block h-full">
                <div class="aspect-w-4 aspect-h-3 bg-gray-100 relative overflow-hidden">
                    {% if item.cover_image %}
                        <img src="{{ item.cover_image.url }}" alt="{{ item.title }}" class="object-cover w-full h-full group-hover:scale-105 transition-transform duration-500">
                    {% else %}
                        <div class="flex items-center justify-center h-full text-gray-400">
                            <span class="text-sm">Нет обложки</span>
                        </div>
                    {% endif %}
                </div>
            </a>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-10 text-gray-500">
            В этой папке пока нет альбомов.
        </div>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const timerEl = document.getElementById('countdown-timer');
        if (!timerEl) return;

        // Получаем дату из атрибута data-expires (ISO формат)
        const expiresStr = timerEl.dataset.expires;
        const targetDate = new Date(expiresStr).getTime();

        function updateTimer() {
            const now = new Date().getTime();
            const distance = targetDate - now;

            if (distance < 0) {
                timerEl.innerHTML = "00 00 00 00";
                timerEl.classList.remove('text-red-600');
                timerEl.classList.add('text-gray-400');
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Форматируем с нулями (05 вместо 5)
            const d = days < 10 ? "0" + days : days;
            const h = hours < 10 ? "0" + hours : hours;
            const m = minutes < 10 ? "0" + minutes : minutes;
            const s = seconds < 10 ? "0" + seconds : seconds;

            timerEl.innerHTML = `${d} ${h} ${m} ${s}`;
        }

        updateTimer(); // Запуск сразу
        setInterval(updateTimer, 1000); // Обновление каждую секунду
    });
</script>
{% endblock %}
